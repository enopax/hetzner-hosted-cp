{{/*
K0smotronControlPlane resource - Hosted control plane configuration
This resource defines a control plane that runs as pods in the management cluster
instead of on dedicated infrastructure machines. It supports two access modes:
- Ingress mode: hostname-based access via HAProxy ingress with SSL passthrough
- NodePort mode: direct access via management cluster node IP and NodePort
*/}}
{{- $useIngress := and .Values.controlPlane.ingress .Values.controlPlane.ingress.apiHost }}
apiVersion: controlplane.cluster.x-k8s.io/v1beta1
kind: K0smotronControlPlane
metadata:
  name: {{ include "k0smotroncontrolplane.name" . }}
spec:
  version: {{ .Values.k0s.version }}
  replicas: {{ .Values.controlPlane.replicas | default 1 }}
  externalAddress: {{ if $useIngress }}"kmc-{{ include "cluster.name" . }}.{{ .Release.Namespace }}.svc.cluster.local"{{ else }}{{ .Values.controlPlane.endpoint.host | quote }}{{ end }}
  {{- if $useIngress }}
  # Ingress mode: hostname-based access via management cluster ingress
  ingress:
    enabled: true
    className: haproxy
    annotations:
      haproxy.org/ssl-passthrough: "true"
    apiHost: {{ .Values.controlPlane.ingress.apiHost }}
    konnectivityHost: {{ .Values.controlPlane.ingress.konnectivityHost }}
  {{- end }}
  service:
    type: {{ .Values.controlPlane.service.type | default "ClusterIP" }}
    {{- if eq (.Values.controlPlane.service.type | default "ClusterIP") "NodePort" }}
    apiNodePort: {{ .Values.controlPlane.service.apiNodePort | default 30443 }}
    konnectivityNodePort: {{ .Values.controlPlane.service.konnectivityNodePort | default 30132 }}
    {{- end }}
  k0sConfig:
    apiVersion: k0s.k0sproject.io/v1beta1
    kind: ClusterConfig
    metadata:
      name: k0s
    spec:
      api:
        sans:
          {{- if $useIngress }}
          - {{ .Values.controlPlane.ingress.apiHost }}
          - {{ .Values.controlPlane.ingress.konnectivityHost }}
          {{- end }}
          {{- if and .Values.controlPlane.endpoint .Values.controlPlane.endpoint.host }}
          - {{ .Values.controlPlane.endpoint.host | quote }}
          {{- end }}
          - "kmc-{{ include "cluster.name" . }}.{{ .Release.Namespace }}.svc.cluster.local"
        extraArgs:
          anonymous-auth: "true"
          {{- with .Values.k0s.api.extraArgs }}
          {{- toYaml . | nindent 10 }}
          {{- end }}
      {{- with .Values.k0s.network }}
      network: {{ toYaml . | nindent 8 }}
      {{- end }}
      extensions:
        helm:
          repositories: []
          charts: []
      telemetry:
        enabled: false
