{{/*
HetznerCluster resource - Hetzner Cloud infrastructure configuration
This resource defines the Hetzner Cloud infrastructure including:
- Control plane endpoint configuration (via ingress hostname or NodePort)
- Private networking configuration (optional)
- SSH keys and placement groups for worker nodes
- API token reference for Hetzner Cloud API access
*/}}
apiVersion: infrastructure.cluster.x-k8s.io/v1beta1
kind: HetznerCluster
metadata:
  name: {{ include "cluster.name" . }}
  finalizers:
    - k0rdent.mirantis.com/cleanup
spec:
  controlPlaneRegions:
    - {{ .Values.region }}
  {{- if .Values.sshKeyNames }}
  sshKeys:
    hcloud:
    {{- range .Values.sshKeyNames }}
      - name: {{ . }}
    {{- end }}
  {{- end }}
  hcloudTokenRef:
    name: {{ .Values.tokenRef.name }}
    key: {{ .Values.tokenRef.key }}
  {{- if .Values.placementGroupName }}
  placementGroups:
    - name: {{ .Values.placementGroupName }}
      type: spread
  {{- end }}
  {{- if .Values.labels }}
  labels:
    {{- toYaml .Values.labels | nindent 4 }}
  {{- end }}
  controlPlaneLoadBalancer:
    enabled: false  # Disabled for hosted control plane
  controlPlaneEndpoint:
    {{- if and .Values.controlPlane.ingress .Values.controlPlane.ingress.apiHost }}
    # Ingress mode: workers connect via ingress hostname
    host: {{ .Values.controlPlane.ingress.apiHost | quote }}
    port: 443
    {{- else }}
    # NodePort mode: workers connect via management cluster node IP
    host: {{ required "controlPlane.endpoint.host is required when ingress is not configured" .Values.controlPlane.endpoint.host | quote }}
    port: {{ .Values.controlPlane.service.apiNodePort | default 30443 }}
    {{- end }}
  {{- if .Values.hcloudNetwork }}
  hcloudNetwork:
    enabled: {{ .Values.hcloudNetwork.enabled }}
    cidrBlock: {{ .Values.hcloudNetwork.cidrBlock | quote }}
    subnetCidrBlock: {{ .Values.hcloudNetwork.subnetCidrBlock | quote }}
    networkZone: {{ .Values.hcloudNetwork.networkZone | quote }}
  {{- end }}
  hetznerSecretRef:
    name: {{ .Values.tokenRef.name }}
    key:
      hcloudToken: {{ .Values.tokenRef.key }}
